<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Message Sender Application</title>
    <style>
		
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 2rem; }
		.app-header {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    padding: 15px 30px;
		    background-color: #ffffff;
		    border-bottom: 1px solid #e0e0e0;
		    max-width: 1400px;
		    margin: -2rem auto 2rem auto;
		    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}
		.app-title {
		    font-size: 1.8rem;
		    color: #1c1e21;
		    margin: 0;
		    border: none;
		    text-align: center;
		}	
			.header-spacer, .user-info {
		    flex: 1; /* This makes the left and right sides take up equal space */
		}
		.user-info {
		    display: flex;
		    justify-content: flex-end; /* Aligns items to the far right */
		    align-items: center;
		    gap: 20px;
		}
		        .user-details {
		            text-align: right;
		            line-height: 1.2;
		        }
		        .username {
		            font-weight: 600;
		            font-size: 1rem;
		            color: #333;
		        }
		        #live-clock {
		            font-size: 0.8rem;
		            color: #606770;
		        }
		        .button-logout {
		            background-color: #f0f2f5;
		            color: #333;
		            font-weight: 600;
		            border: 1px solid #ccc;
		            padding: 8px 16px;
		            border-radius: 6px;
		            cursor: pointer;
		            transition: background-color 0.2s;
		        }
		        .button-logout:hover {
		            background-color: #e4e6eb;
		        }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #1c1e21; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; margin-top: 0; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; color: #606770; font-weight: 600; }
        input[type="text"], textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #ccd0d5; border-radius: 6px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 120px; }
        .button { background-color: #1877f2; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; width: 100%; font-weight: 600; }
        .button-search { background-color: #42b72a; width: auto; }
        .button-delete { background-color: #fa3e3e; font-size: 0.8rem; padding: 0.3rem 0.6rem; width: auto; }
        .button:hover { background-color: #166fe5; }
        .button-search:hover { background-color: #36a420; }
        .alert-success { padding: 1rem; background-color: #e7f3ff; color: #1877f2; border: 1px solid #bde0ff; border-radius: 6px; margin-bottom: 1rem; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { text-align: left; padding: 0.8rem; border-bottom: 1px solid #ddd; }
        th { background-color: #f5f6f7; }
        .status-sent { color: #31a24c; font-weight: bold; }
        .status-failed { color: #fa3e3e; font-weight: bold; }
        .pagination { display: flex; justify-content: center; padding: 1rem 0; list-style: none; }
        .pagination li { margin: 0 5px; }
        .pagination a { color: #1877f2; text-decoration: none; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
        .pagination li.active a { background-color: #1877f2; color: white; border-color: #1877f2; }
        .pagination li.disabled a { color: #ccc; pointer-events: none; }
    </style>
	<script>
		    const token = localStorage.getItem('jwtToken');
		    if (!token) {
		        window.location.href = '/login';
		    }

		    document.addEventListener('DOMContentLoaded', function() {
		        // Logout functionality
		        document.getElementById('logoutButton').addEventListener('click', function() {
		            localStorage.removeItem('jwtToken');
		            window.location.href = '/login';
		        });
	            
	            // Template dropdown functionality
	            const templateSelect = document.getElementById('template-select');
	            if (templateSelect) {
	                templateSelect.addEventListener('change', function() {
	                    var selectedValue = this.value;
	                    document.getElementById('smsMessage').value = selectedValue;
	                    document.getElementById('whatsappMessage').value = selectedValue;
	                });
	            }
	            const clockElement = document.getElementById('live-clock');
	            function updateClock() {
	                const now = new Date();
	                clockElement.textContent = now.toLocaleTimeString();
	            }
	            setInterval(updateClock, 1000); //every second
	            updateClock();
		    });
		</script>
</head>
<body>
	<header class="app-header">
	    <div class="header-spacer"></div> <h1 class="app-title">Message Sender ðŸš€</h1>
	    <div class="user-info">
	        <div class="user-details">
	            <span class="username" th:text="${loggedInUsername}">Username</span>
	            <div id="live-clock"></div>
	        </div>
	        <button id="logoutButton" class="button-logout">Logout</button>
	    </div>
	</header>
<div th:if="${successMessage}" class="alert-success" th:text="${successMessage}"></div>

<div class="grid-container">

    <div>
        <div class="card">
            <h2>Send a Message</h2>
            <form th:action="@{/send-message}" method="post">
                <div class="form-group">
                    <label for="to">Recipient Number (E.164 format):</label>
                    <input type="text" id="to" name="to" th:value="${recipient}" required>
                </div>
                <div class="form-group" sec:authorize="hasRole('ADMIN')">
                    <label for="template-select">Use a Template (Optional):</label>
                    <select id="template-select">
                        <option value="">-- Select a Template --</option>
                        <option th:each="template : ${allTemplates}" th:value="${template.messageBody}" th:text="${template.templateName}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="smsMessage">SMS Message:</label>
                    <textarea id="smsMessage" name="smsMessage" placeholder="Enter SMS text or select a template..."></textarea>
                </div>
                <div class="form-group">
                    <label for="whatsappMessage">WhatsApp Message:</label>
                    <textarea id="whatsappMessage" name="whatsappMessage" placeholder="Enter WhatsApp text or select a template..."></textarea>
                </div>
                <button type="submit" class="button">Send Message</button>
            </form>
        </div>

        <div class="card" style="margin-top: 2rem;" sec:authorize="hasRole('ADMIN')">
            <h2>Manage Templates</h2>
            <form th:action="@{/add-template}" method="post">
                <div class="form-group">
                    <label for="templateName">Template Name:</label>
                    <input type="text" id="templateName" name="templateName" required>
                </div>
                <div class="form-group">
                    <label for="templateBody">Template Body:</label>
                    <textarea id="templateBody" name="templateBody" required></textarea>
                </div>
                <button type="submit" class="button">Save New Template</button>
            </form>
        </div>
    </div>

    <div>
        <div class="card">
            <h2>Message History</h2>
            <table th:if="${logPage.hasContent()}">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Recipient</th>
                        <th>Message</th>
                        <th>Status</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="log : ${logPage.content}">
                        <td th:text="${log.messageType}"></td>
                        <!-- <td th:text="${log.recipientNumber}"></td> -->
						<td th:text="${#strings.substring(log.recipientNumber, 0, #strings.length(log.recipientNumber) - 4) + 'XXXX'}"></td>
                        <td th:text="${#strings.abbreviate(log.messageBody, 50)}"></td>
                        <td>
                            <span th:text="${log.status}"
                                  th:classappend="${log.status == 'DELIVERED'} ? 'status-delivered' : (${log.status == 'FAILED'} ? 'status-failed' : 'status-sent')">
                            </span>
                        </td>
                        <td th:text="${#temporals.format(log.timestamp, 'dd-MMM-yyyy HH:mm')}"></td>
                    </tr>
                </tbody>
            </table>
            <div th:if="${!logPage.hasContent()}">
                <p>No message history found.</p>
            </div>
            <nav th:if="${logPage.totalPages > 1}">
                <ul class="pagination">
                    <li th:classappend="${logPage.isFirst()} ? 'disabled'">
                        <a th:href="@{/(logPage=${logPage.number-1}, logSize=${logPage.size}, searchName=${searchName}, templatePage=${templatePage.number})}">Â« Prev</a>
                    </li>
                    <li th:each="pageNumber : ${#numbers.sequence(0, logPage.totalPages-1)}" th:classappend="${pageNumber == logPage.number} ? 'active'">
                        <a th:href="@{/(logPage=${pageNumber}, logSize=${logPage.size}, searchName=${searchName}, templatePage=${templatePage.number})}" th:text="${pageNumber + 1}"></a>
                    </li>
                    <li th:classappend="${logPage.isLast()} ? 'disabled'">
                        <a th:href="@{/(logPage=${logPage.number+1}, logSize=${logPage.size}, searchName=${searchName}, templatePage=${templatePage.number})}">Next Â»</a>
                    </li>
                </ul>
            </nav>
        </div>

        <div class="card" style="margin-top: 2rem;" sec:authorize="hasRole('ADMIN')">
            <h3>Existing Templates</h3>
            <form th:action="@{/}" method="get" style="display: flex; gap: 10px; margin-bottom: 1rem;">
                <input type="text" name="searchName" placeholder="Search by name..." th:value="${searchName}" style="flex-grow: 1;">
                <button type="submit" class="button button-search">Search</button>
            </form>
            <table th:if="${templatePage.hasContent()}">
                <tr th:each="template : ${templatePage.content}">
                    <td th:text="${template.templateName}"></td>
                    <td>
                        <form th:action="@{/delete-template/{id}(id=${template.id})}" method="post" style="display:inline;">
                            <button type="submit" class="button button-delete">Delete</button>
                        </form>
                    </td>
                </tr>
            </table>
            <div th:if="${!templatePage.hasContent()}">
                <p>No templates found.</p>
            </div>
            <nav th:if="${templatePage.totalPages > 1}">
                <ul class="pagination">
                    <li th:classappend="${templatePage.isFirst()} ? 'disabled'">
                        <a th:href="@{/(size=${templatePage.size}, page=${templatePage.number-1}, searchName=${searchName})}">Â« Prev</a>
                    </li>
                    <li th:each="pageNumber : ${#numbers.sequence(0, templatePage.totalPages-1)}" th:classappend="${pageNumber == templatePage.number} ? 'active'">
                        <a th:href="@{/(size=${templatePage.size}, page=${pageNumber}, searchName=${searchName})}" th:text="${pageNumber + 1}"></a>
                    </li>
                    <li th:classappend="${templatePage.isLast()} ? 'disabled'">
                        <a th:href="@{/(size=${templatePage.size}, page=${templatePage.number+1}, searchName=${searchName})}">Next Â»</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

</div>
</body>
</html>